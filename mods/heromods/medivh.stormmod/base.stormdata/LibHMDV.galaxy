include "TriggerLibs/NativeLib"
include "TriggerLibs/HeroesLib"
include "TriggerLibs/GameLib"
include "TriggerLibs/AILib"
include "TriggerLibs/UILib"

include "LibHMDV_h"

//--------------------------------------------------------------------------------------------------
// Library: Medivh
//--------------------------------------------------------------------------------------------------
// External Library Initialization
void libHMDV_InitLibraries () {
    libNtve_InitVariables();
    libCore_InitVariables();
    libGame_InitVariables();
    libAIAI_InitVariables();
    libUIUI_InitVariables();
}

// Variable Initialization
bool libHMDV_InitVariables_completed = false;

void libHMDV_InitVariables () {
    int init_i;

    if (libHMDV_InitVariables_completed) {
        return;
    }

    libHMDV_InitVariables_completed = true;

    for (init_i = 0; init_i <= libCore_gv_bALMaxPlayers; init_i += 1) {
        libHMDV_gv_medivhForceofWillPlayerGroup[init_i] = PlayerGroupEmpty();
    }
}

// Custom Script
//--------------------------------------------------------------------------------------------------
// Custom Script: #Include Medivh Tactical AI
//--------------------------------------------------------------------------------------------------
include "StormTactical.galaxy"
include "MedivhTactical.galaxy"

void libHMDV_InitCustomScript () {
}

// Functions
void libHMDV_gf_HeroMedivhIncrementHeroCountFunction () {
    // Implementation
    libHMDV_gv_heroMedivhTriggerRegistrationVariable += 1;
    if ((libHMDV_gv_heroMedivhTriggerRegistrationVariable == 1)) {
        TriggerEnable(libHMDV_gt_HeroMedivhLeyLineSealOverlayOn, true);
        TriggerEnable(libHMDV_gt_HeroMedivhLeyLineSealOverlayOff, true);
        TriggerEnable(libHMDV_gt_HeroMedivhPortalTeleport, true);
        TriggerEnable(libHMDV_gt_HeroMedivhPortalCameraPan, true);
        TriggerEnable(libHMDV_gt_HeroMedivhPortalPortalMasterySelectionClamping, true);
        TriggerEnable(libHMDV_gt_HeroMedivhPortalPortalMasteryMorphBackToMedivh, true);
        TriggerEnable(libHMDV_gt_HeroMedivhForceofWillBehaviorResponses, true);
        TriggerEnable(libHMDV_gt_HeroMedivhTransformRavenAfterPortToTown, true);
        TriggerEnable(libHMDV_gt_HeroMedivhTransformRavenMountingSpecialCase, true);
        TriggerEnable(libHMDV_gt_HeroMedivhTransformSwapToMedivh, true);
        TriggerEnable(libHMDV_gt_HeroAIAIMedivhHasCastPortalOne, true);
        TriggerEnable(libHMDV_gt_HeroAIAIMedivhRegisterPortalCast, true);
        TriggerEnable(libHMDV_gt_HeroAIMedivhHasCastRavenForm, true);
        TriggerEnable(libHMDV_gt_HeroAIMedivhHasLanded, true);
        TriggerEnable(libHMDV_gt_HeroAIAIMedivhUnregisterPortal, true);
    }

}

void libHMDV_gf_HeroMedivhDecrementHeroCountFunction () {
    // Implementation
    libHMDV_gv_heroMedivhTriggerRegistrationVariable -= 1;
    if ((libHMDV_gv_heroMedivhTriggerRegistrationVariable < 0)) {
        libHMDV_gv_heroMedivhTriggerRegistrationVariable = 0;
    }

    if ((libHMDV_gv_heroMedivhTriggerRegistrationVariable == 0)) {
        TriggerEnable(libHMDV_gt_HeroMedivhLeyLineSealOverlayOn, false);
        TriggerEnable(libHMDV_gt_HeroMedivhLeyLineSealOverlayOff, false);
        TriggerEnable(libHMDV_gt_HeroMedivhPortalTeleport, false);
        TriggerEnable(libHMDV_gt_HeroMedivhPortalCameraPan, false);
        TriggerEnable(libHMDV_gt_HeroMedivhPortalPortalMasterySelectionClamping, false);
        TriggerEnable(libHMDV_gt_HeroMedivhPortalPortalMasteryMorphBackToMedivh, false);
        TriggerEnable(libHMDV_gt_HeroMedivhForceofWillBehaviorResponses, false);
        TriggerEnable(libHMDV_gt_HeroMedivhTransformRavenAfterPortToTown, false);
        TriggerEnable(libHMDV_gt_HeroMedivhTransformRavenMountingSpecialCase, false);
        TriggerEnable(libHMDV_gt_HeroMedivhTransformSwapToMedivh, false);
        TriggerEnable(libHMDV_gt_HeroAIAIMedivhHasCastPortalOne, false);
        TriggerEnable(libHMDV_gt_HeroAIAIMedivhRegisterPortalCast, false);
        TriggerEnable(libHMDV_gt_HeroAIMedivhHasCastRavenForm, false);
        TriggerEnable(libHMDV_gt_HeroAIMedivhHasLanded, false);
        TriggerEnable(libHMDV_gt_HeroAIAIMedivhUnregisterPortal, false);
    }

}

point libHMDV_gf_HeroAIMedivhFindPortalTwoPoint (int lp_medivhPlayer, unit lp_medivhUnit, unit lp_savedUnit) {
    // Variable Declarations
    unit lv_portalOneUnit;
    point lv_retreatPoint;

    // Variable Initialization

    // Implementation
    lv_portalOneUnit = libHMDV_gf_HeroAIMedivhFindFirstPortal(lp_medivhPlayer);
    if ((UnitIsAlive(lv_portalOneUnit) == false)) {
        return null;
    }

    if ((lp_savedUnit == null)) {
        lv_retreatPoint = libAIAI_gf_HeroAIGetRetreatPosition(lp_medivhPlayer, 16.0, UnitGetPosition(lp_medivhUnit));
        return lv_retreatPoint;
    }
    else {
        lv_retreatPoint = libAIAI_gf_HeroAIGetRetreatPosition(UnitGetOwner(lp_savedUnit), 16.0, UnitGetPosition(lp_savedUnit));
        return lv_retreatPoint;
    }
}

unit libHMDV_gf_HeroAIMedivhFindFirstPortal (int lp_player) {
    // Variable Declarations
    unitgroup lv_portalUnitGroup;

    // Variable Initialization
    lv_portalUnitGroup = UnitGroupEmpty();

    // Implementation
    lv_portalUnitGroup = libNtve_gf_UnitsInRegionWithAllianceToPlayerMatchingCondition("MedivhPortalPlacementMarker", "MedivhPortal", "", lp_player, -1, RegionCircle(UnitGetPosition(libGame_gv_players[lp_player].lv_heroUnit), 17.0), UnitFilter(0, 0, (1 << c_targetFilterSelf) | (1 << c_targetFilterNeutral) | (1 << c_targetFilterEnemy) | (1 << c_targetFilterMissile), (1 << (c_targetFilterDead - 32)) | (1 << (c_targetFilterHidden - 32))), 0);
    if ((UnitGroupCount(lv_portalUnitGroup, c_unitCountAlive) == 1)) {
        return UnitGroupUnit(lv_portalUnitGroup, 1);
    }
    else {
        return null;
    }
}

unitgroup libHMDV_gf_HeroAIMedivhFindPortalPair (int lp_player) {
    // Variable Declarations
    unitgroup lv_portalUnitGroup;

    // Variable Initialization
    lv_portalUnitGroup = UnitGroupEmpty();

    // Implementation
    if ((lp_player >= 1) && (lp_player <= libCore_gv_bALMaxPlayers)) {
        return libNtve_gf_UnitsInRegionWithAllianceToPlayerMatchingCondition("MedivhPortal", "", "", lp_player, -1, RegionEntireMap(), UnitFilter(0, 0, (1 << c_targetFilterSelf) | (1 << c_targetFilterNeutral) | (1 << c_targetFilterEnemy) | (1 << c_targetFilterMissile), (1 << (c_targetFilterDead - 32)) | (1 << (c_targetFilterHidden - 32))), 0);
    }
    else {
        if ((libCore_gv_dEBUGDebuggingEnabled == true)) {
            TriggerDebugOutput(1, StringExternal("Param/Value/lib_HMDV_028E66AC"), true);
        }

        return null;
    }
}

// Triggers
//--------------------------------------------------------------------------------------------------
// Trigger: HeroAI - Medivh Has Landed
//--------------------------------------------------------------------------------------------------
bool libHMDV_gt_HeroAIMedivhHasLanded_Func (bool testConds, bool runActions) {
    // Conditions
    if (testConds) {
        if (!((libAIAI_gf_HeroAIIsAIEnabledForPlayer(UnitGetOwner(EventUnit())) == true))) {
            return false;
        }
    }

    // Actions
    if (!runActions) {
        return true;
    }

    AISetSuppressDangerPathing(EventUnit(), false);
    return true;
}

//--------------------------------------------------------------------------------------------------
void libHMDV_gt_HeroAIMedivhHasLanded_Init () {
    libHMDV_gt_HeroAIMedivhHasLanded = TriggerCreate("libHMDV_gt_HeroAIMedivhHasLanded_Func");
    TriggerEnable(libHMDV_gt_HeroAIMedivhHasLanded, false);
    TriggerAddEventUnitAbility(libHMDV_gt_HeroAIMedivhHasLanded, null, AbilityCommand("MedivhTransformRavenLand", 0), c_unitAbilStageComplete, false);
}

//--------------------------------------------------------------------------------------------------
// Trigger: HeroAI - Medivh Has Cast Raven Form
//--------------------------------------------------------------------------------------------------
bool libHMDV_gt_HeroAIMedivhHasCastRavenForm_Func (bool testConds, bool runActions) {
    // Conditions
    if (testConds) {
        if (!((libAIAI_gf_HeroAIIsAIEnabledForPlayer(UnitGetOwner(EventUnit())) == true))) {
            return false;
        }
    }

    // Actions
    if (!runActions) {
        return true;
    }

    AISetSuppressDangerPathing(EventUnit(), true);
    return true;
}

//--------------------------------------------------------------------------------------------------
void libHMDV_gt_HeroAIMedivhHasCastRavenForm_Init () {
    libHMDV_gt_HeroAIMedivhHasCastRavenForm = TriggerCreate("libHMDV_gt_HeroAIMedivhHasCastRavenForm_Func");
    TriggerEnable(libHMDV_gt_HeroAIMedivhHasCastRavenForm, false);
    TriggerAddEventUnitAbility(libHMDV_gt_HeroAIMedivhHasCastRavenForm, null, AbilityCommand("MedivhTransformRaven", 0), c_unitAbilStageComplete, false);
    TriggerAddEventUnitAbility(libHMDV_gt_HeroAIMedivhHasCastRavenForm, null, AbilityCommand("MedivhTransformRavenMorph", 0), c_unitAbilStageComplete, false);
}

//--------------------------------------------------------------------------------------------------
// Trigger: HeroAI - AI Medivh Has Cast Portal One
//--------------------------------------------------------------------------------------------------
bool libHMDV_gt_HeroAIAIMedivhHasCastPortalOne_Func (bool testConds, bool runActions) {
    // Variable Declarations
    order lv_portalTwo;
    point lv_targetPoint;
    unit lv_secondPortal;

    // Variable Initialization
    lv_secondPortal = libHMDV_gf_HeroAIMedivhFindFirstPortal(UnitGetOwner(EventUnit()));

    // Conditions
    if (testConds) {
        if (!((libAIAI_gf_HeroAIIsAIEnabledForPlayer(UnitGetOwner(EventUnit())) == true))) {
            return false;
        }
    }

    // Actions
    if (!runActions) {
        return true;
    }

    lv_targetPoint = libHMDV_gf_HeroAIMedivhFindPortalTwoPoint(UnitGetOwner(EventUnit()), EventUnit(), libAIAI_gv_heroAIMedivhCurrentSavedUnit[UnitGetOwner(EventUnit())]);
    if ((lv_targetPoint != null)) {
        UnitIssueOrder(lv_secondPortal, OrderTargetingPoint(AbilityCommand("MedivhPortal2", 0), lv_targetPoint), c_orderQueueReplace);
    }
    else {
        UnitIssueOrder(EventUnit(), Order(AbilityCommand("MedivhPortalCancel", 0)), c_orderQueueReplace);
    }
    return true;
}

//--------------------------------------------------------------------------------------------------
void libHMDV_gt_HeroAIAIMedivhHasCastPortalOne_Init () {
    libHMDV_gt_HeroAIAIMedivhHasCastPortalOne = TriggerCreate("libHMDV_gt_HeroAIAIMedivhHasCastPortalOne_Func");
    TriggerEnable(libHMDV_gt_HeroAIAIMedivhHasCastPortalOne, false);
    TriggerAddEventUnitAbility(libHMDV_gt_HeroAIAIMedivhHasCastPortalOne, null, AbilityCommand("MedivhPortal1", 0), c_abilEffectStageFinish, false);
}

//--------------------------------------------------------------------------------------------------
// Trigger: HeroAI - AI Medivh Register Portal Cast
//--------------------------------------------------------------------------------------------------
bool libHMDV_gt_HeroAIAIMedivhRegisterPortalCast_Func (bool testConds, bool runActions) {
    // Variable Declarations
    int lv_player;
    unitgroup lv_portals;
    unit lv_portalUnit;
    fixed lv_duration;

    // Variable Initialization
    lv_portalUnit = EventUnit();
    lv_duration = 6.0;

    // Actions
    if (!runActions) {
        return true;
    }

    Wait(0.0625, c_timeGame);
    lv_player = UnitGetOwner(lv_portalUnit);
    if ((lv_player > libCore_gv_bALMaxPlayers)) {
        return true;
    }

    lv_portals = libHMDV_gf_HeroAIMedivhFindPortalPair(lv_player);
    if ((UnitGroupCount(lv_portals, c_unitCountAlive) != 2)) {
        return true;
    }

    if ((lv_portalUnit == UnitGroupUnit(lv_portals, 1))) {
        libAIAI_gf_HeroAIRegisterPortalPair(lv_player, lv_portalUnit, UnitGroupUnit(lv_portals, 2), 0.5, lv_duration, "SmartCommandUnitInteraction");
    }
    else {
        libAIAI_gf_HeroAIRegisterPortalPair(lv_player, lv_portalUnit, UnitGroupUnit(lv_portals, 1), 0.5, lv_duration, "SmartCommandUnitInteraction");
    }
    return true;
}

//--------------------------------------------------------------------------------------------------
void libHMDV_gt_HeroAIAIMedivhRegisterPortalCast_Init () {
    libHMDV_gt_HeroAIAIMedivhRegisterPortalCast = TriggerCreate("libHMDV_gt_HeroAIAIMedivhRegisterPortalCast_Func");
    TriggerEnable(libHMDV_gt_HeroAIAIMedivhRegisterPortalCast, false);
    TriggerAddEventUnitBehaviorChange(libHMDV_gt_HeroAIAIMedivhRegisterPortalCast, null, "MedivhPortalTimedLife", c_unitBehaviorChangeCreate);
}

//--------------------------------------------------------------------------------------------------
// Trigger: HeroAI - AI Medivh Unregister Portal
//--------------------------------------------------------------------------------------------------
bool libHMDV_gt_HeroAIAIMedivhUnregisterPortal_Func (bool testConds, bool runActions) {
    // Variable Declarations
    int lv_player;
    unitgroup lv_portals;
    unit lv_portalUnit;

    // Variable Initialization
    lv_portals = libHMDV_gf_HeroAIMedivhFindPortalPair(UnitGetOwner(EventUnit()));
    lv_portalUnit = EventUnit();

    // Conditions
    if (testConds) {
        if (!((UnitGroupCount(lv_portals, c_unitCountAlive) == 2))) {
            return false;
        }
    }

    // Actions
    if (!runActions) {
        return true;
    }

    lv_player = UnitGetOwner(lv_portalUnit);
    libAIAI_gf_HeroAIUnregisterPortalPair(lv_player, lv_portalUnit);
    return true;
}

//--------------------------------------------------------------------------------------------------
void libHMDV_gt_HeroAIAIMedivhUnregisterPortal_Init () {
    libHMDV_gt_HeroAIAIMedivhUnregisterPortal = TriggerCreate("libHMDV_gt_HeroAIAIMedivhUnregisterPortal_Func");
    TriggerEnable(libHMDV_gt_HeroAIAIMedivhUnregisterPortal, false);
    TriggerAddEventUnitBehaviorChange(libHMDV_gt_HeroAIAIMedivhUnregisterPortal, null, "MedivhPortalAIUseLink", c_unitBehaviorChangeDecrease);
}

//--------------------------------------------------------------------------------------------------
// Trigger: HeroAI - Misc Mod Initialization
//--------------------------------------------------------------------------------------------------
bool libHMDV_gt_HeroAIMiscModInitialization_Func (bool testConds, bool runActions) {
    // Actions
    if (!runActions) {
        return true;
    }

    libCore_gf_RegisterSegregationTrigger(libCore_ge_SegregationTriggerTypes_HeroAIInitializeHeroTierData, libHMDV_gt_HeroAIAddToTierDataMedivh);
    libCore_gf_RegisterSegregationTrigger(libCore_ge_SegregationTriggerTypes_HeroAIInitAbilities, libHMDV_gt_HeroAIInitAbilitiesMedivh);
    libAIAI_gf_HeroAIRegisterAOEwithWatchTrigger("MedivhPolyBombApplyBehavior", 3.0, 3.0, 0.0, true, true);
    return true;
}

//--------------------------------------------------------------------------------------------------
void libHMDV_gt_HeroAIMiscModInitialization_Init () {
    libHMDV_gt_HeroAIMiscModInitialization = TriggerCreate("libHMDV_gt_HeroAIMiscModInitialization_Func");
    TriggerAddEventMapInit(libHMDV_gt_HeroAIMiscModInitialization);
}

//--------------------------------------------------------------------------------------------------
// Trigger: HeroAI - Add To Tier Data - Medivh
//--------------------------------------------------------------------------------------------------
bool libHMDV_gt_HeroAIAddToTierDataMedivh_Func (bool testConds, bool runActions) {
    // Actions
    if (!runActions) {
        return true;
    }

    libAIAI_gf_HeroAIAddHeroToTierData(libAIAI_ge_HeroAIHeroTiers_TierHigh, "Medivh");
    return true;
}

//--------------------------------------------------------------------------------------------------
void libHMDV_gt_HeroAIAddToTierDataMedivh_Init () {
    libHMDV_gt_HeroAIAddToTierDataMedivh = TriggerCreate("libHMDV_gt_HeroAIAddToTierDataMedivh_Func");
}

//--------------------------------------------------------------------------------------------------
// Trigger: HeroAI - Init Abilities - Medivh
//--------------------------------------------------------------------------------------------------
bool libHMDV_gt_HeroAIInitAbilitiesMedivh_Func (bool testConds, bool runActions) {
    // Actions
    if (!runActions) {
        return true;
    }

    if (((UnitGetType(libCore_gv_segTriggerUnit) == "HeroMedivh") || (UnitGetType(libCore_gv_segTriggerUnit) == "HeroMedivhRaven"))) {
        libAIAI_gv_heroAIInitAbilitesHeroFound = true;
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_hasTactical = true;
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_hasMount = true;
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_mountAbility = AbilityCommand("MedivhTransformRaven", 0);
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_dismountAbility = AbilityCommand("MedivhTransformRavenLand", 0);
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_mountBehavior = "MedivhTransformRaven";
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_castAbility[0] = AbilityCommand("MedivhArcaneRift", 0);
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_abilityType[0] = libAIAI_ge_HeroAISpellType_PointEnemy;
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_abilityRange[0] = 10.0;
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_castAbility[1] = AbilityCommand("MedivhForceOfWill", 0);
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_abilityType[1] = libAIAI_ge_HeroAISpellType_TargetFriendly;
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_abilityRange[1] = 13.0;
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_castAbility[2] = AbilityCommand("MedivhPortalInstant", 0);
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_abilityType[2] = libAIAI_ge_HeroAISpellType_PointFriendly;
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_abilityRange[2] = 16.0;
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_castAbility[3] = AbilityCommand("MedivhPolyBomb", 0);
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_abilityType[3] = libAIAI_ge_HeroAISpellType_TargetHeroEnemy;
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_abilityRange[3] = 7.0;
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_castAbility[4] = AbilityCommand("MedivhLeyLineSeal", 0);
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_abilityType[4] = libAIAI_ge_HeroAISpellType_PointEnemy;
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_abilityRange[4] = 30.0;
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_hasFlyingMount = true;
    }

    return true;
}

//--------------------------------------------------------------------------------------------------
void libHMDV_gt_HeroAIInitAbilitiesMedivh_Init () {
    libHMDV_gt_HeroAIInitAbilitiesMedivh = TriggerCreate("libHMDV_gt_HeroAIInitAbilitiesMedivh_Func");
}

//--------------------------------------------------------------------------------------------------
// Trigger: Hero - Medivh - Ley Line Seal Overlay On
//--------------------------------------------------------------------------------------------------
bool libHMDV_gt_HeroMedivhLeyLineSealOverlayOn_Func (bool testConds, bool runActions) {
    // Variable Declarations
    unit lv_unit;

    // Variable Initialization
    lv_unit = EventUnit();

    // Actions
    if (!runActions) {
        return true;
    }

    if ((UnitIsAlive(lv_unit) == true) && (UnitTestState(lv_unit, c_unitStateHallucination) == false) && (UnitHasBehavior2(lv_unit, "HeroGenericIgnoreFullscreenOverlay") == false)) {
        libUIUI_gf_FullscreenOverlayAddItemForPlayer(UnitGetOwner(lv_unit), libUIUI_ge_FullscreenOverlayPriorities_Stasis, "Cutscenes\\GameUI_StasisOverlay.StormCutscene", EventUnitBehavior());
    }

    return true;
}

//--------------------------------------------------------------------------------------------------
void libHMDV_gt_HeroMedivhLeyLineSealOverlayOn_Init () {
    libHMDV_gt_HeroMedivhLeyLineSealOverlayOn = TriggerCreate("libHMDV_gt_HeroMedivhLeyLineSealOverlayOn_Func");
    TriggerEnable(libHMDV_gt_HeroMedivhLeyLineSealOverlayOn, false);
    TriggerAddEventUnitBehaviorChange(libHMDV_gt_HeroMedivhLeyLineSealOverlayOn, null, "MedivhLeyLineSealStasis", c_unitBehaviorChangeActivate);
}

//--------------------------------------------------------------------------------------------------
// Trigger: Hero - Medivh - Ley Line Seal Overlay Off
//--------------------------------------------------------------------------------------------------
bool libHMDV_gt_HeroMedivhLeyLineSealOverlayOff_Func (bool testConds, bool runActions) {
    // Variable Declarations
    unit lv_unit;

    // Variable Initialization
    lv_unit = EventUnit();

    // Actions
    if (!runActions) {
        return true;
    }

    if ((UnitHasBehavior2(lv_unit, "HeroGenericIgnoreFullscreenOverlay") == false)) {
        libUIUI_gf_FullscreenOverlayRemoveItemFromQueueForPlayer(UnitGetOwner(lv_unit), "Cutscenes\\GameUI_StasisOverlay.StormCutscene", EventUnitBehavior());
    }

    return true;
}

//--------------------------------------------------------------------------------------------------
void libHMDV_gt_HeroMedivhLeyLineSealOverlayOff_Init () {
    libHMDV_gt_HeroMedivhLeyLineSealOverlayOff = TriggerCreate("libHMDV_gt_HeroMedivhLeyLineSealOverlayOff_Func");
    TriggerEnable(libHMDV_gt_HeroMedivhLeyLineSealOverlayOff, false);
    TriggerAddEventUnitBehaviorChange(libHMDV_gt_HeroMedivhLeyLineSealOverlayOff, null, "MedivhLeyLineSealStasis", c_unitBehaviorChangeDestroy);
}

//--------------------------------------------------------------------------------------------------
// Trigger: Hero - Medivh - Portal Teleport
//--------------------------------------------------------------------------------------------------
bool libHMDV_gt_HeroMedivhPortalTeleport_Func (bool testConds, bool runActions) {
    unitgroup auto43A3FC99_g;
    int auto43A3FC99_u;

    // Variable Declarations
    unit lv_itUnit;
    int lv_portalOwner;
    unit lv_portalClicked;
    unit lv_caster;
    unit lv_medivhUnit;

    // Variable Initialization

    // Actions
    if (!runActions) {
        return true;
    }

    lv_caster = EventPlayerEffectUsedUnit(c_effectUnitCaster);
    lv_portalOwner = UnitGetOwner(EventPlayerEffectUsedUnit(c_effectUnitTarget));
    lv_portalClicked = EventPlayerEffectUsedUnit(c_effectUnitTarget);
    if ((UnitGetType(libGame_gv_players[lv_portalOwner].lv_heroUnit) == "HeroAbathur")) {
        lv_medivhUnit = libGame_gv_players[lv_portalOwner].lv_activeVehicle;
    }
    else {
        lv_medivhUnit = libGame_gv_players[lv_portalOwner].lv_heroUnit;
    }
    auto43A3FC99_g = libNtve_gf_UnitsInRegionWithAllianceToPlayerMatchingCondition("MedivhPortal", "", "", lv_portalOwner, c_unitAllianceAlly, RegionEntireMap(), UnitFilter(0, 0, (1 << c_targetFilterSelf) | (1 << c_targetFilterNeutral) | (1 << c_targetFilterEnemy) | (1 << c_targetFilterMissile), (1 << (c_targetFilterDead - 32)) | (1 << (c_targetFilterHidden - 32))), 0);
    auto43A3FC99_u = 1;
    for ( ; auto43A3FC99_u <= UnitGroupCount(auto43A3FC99_g, c_unitCountAll) ; auto43A3FC99_u += (lv_itUnit == UnitGroupUnit(auto43A3FC99_g, auto43A3FC99_u)) ) {
        lv_itUnit = UnitGroupUnit(auto43A3FC99_g, auto43A3FC99_u);
        if ((lv_itUnit != lv_portalClicked) && (UnitGetOwner(lv_itUnit) == lv_portalOwner)) {
            UnitCreateEffectUnit(lv_itUnit, "MedivhPortalTeleport", lv_caster);
            UnitCreateEffectUnit(lv_medivhUnit, "MedivhPortalTeleportSet", lv_caster);
            UnitCreateEffectUnit(lv_itUnit, "MedivhPortalTeleportSetFromPortal", lv_caster);
            break;
        }

    }
    return true;
}

//--------------------------------------------------------------------------------------------------
void libHMDV_gt_HeroMedivhPortalTeleport_Init () {
    libHMDV_gt_HeroMedivhPortalTeleport = TriggerCreate("libHMDV_gt_HeroMedivhPortalTeleport_Func");
    TriggerEnable(libHMDV_gt_HeroMedivhPortalTeleport, false);
    TriggerAddEventPlayerEffectUsed(libHMDV_gt_HeroMedivhPortalTeleport, c_playerAny, "MedivhPortalSmartCommandDummy");
}

//--------------------------------------------------------------------------------------------------
// Trigger: Hero - Medivh - Portal Camera Pan
//--------------------------------------------------------------------------------------------------
bool libHMDV_gt_HeroMedivhPortalCameraPan_Func (bool testConds, bool runActions) {
    // Variable Declarations
    unit lv_teleportTarget;

    // Variable Initialization
    lv_teleportTarget = EventPlayerEffectUsedUnit(c_effectUnitTarget);

    // Actions
    if (!runActions) {
        return true;
    }

    libGame_gf_CameraPanCameraForPlayerAndUpdateMapBoundsIfNecessary(UnitGetOwner(lv_teleportTarget), UnitGetPosition(lv_teleportTarget), 0.0, -1, 0.0, true);
    return true;
}

//--------------------------------------------------------------------------------------------------
void libHMDV_gt_HeroMedivhPortalCameraPan_Init () {
    libHMDV_gt_HeroMedivhPortalCameraPan = TriggerCreate("libHMDV_gt_HeroMedivhPortalCameraPan_Func");
    TriggerEnable(libHMDV_gt_HeroMedivhPortalCameraPan, false);
    TriggerAddEventPlayerEffectUsed(libHMDV_gt_HeroMedivhPortalCameraPan, c_playerAny, "MedivhPortalTeleport");
}

//--------------------------------------------------------------------------------------------------
// Trigger: Hero - Medivh - Portal Portal Mastery Selection (Clamping)
//--------------------------------------------------------------------------------------------------
bool libHMDV_gt_HeroMedivhPortalPortalMasterySelectionClamping_Func (bool testConds, bool runActions) {
    // Variable Declarations
    unit lv_markerPortal;
    unit lv_portalCaster;

    // Variable Initialization

    // Actions
    if (!runActions) {
        return true;
    }

    lv_markerPortal = EventPlayerEffectUsedUnit(c_effectUnitTarget);
    lv_portalCaster = EventPlayerEffectUsedUnit(c_effectUnitCaster);
    UnitSelect(lv_markerPortal, UnitGetOwner(lv_portalCaster), true);
    UISetSelectionTypeEnabled(PlayerGroupSingle(UnitGetOwner(lv_portalCaster)), c_localSelectionTypeWorldPanelHero, false);
    while ((UnitIsAlive(lv_markerPortal) == true)) {
        Wait(0.125, c_timeGame);
    }
    UISetSelectionTypeEnabled(PlayerGroupSingle(UnitGetOwner(lv_portalCaster)), c_localSelectionTypeWorldPanelHero, true);
    return true;
}

//--------------------------------------------------------------------------------------------------
void libHMDV_gt_HeroMedivhPortalPortalMasterySelectionClamping_Init () {
    libHMDV_gt_HeroMedivhPortalPortalMasterySelectionClamping = TriggerCreate("libHMDV_gt_HeroMedivhPortalPortalMasterySelectionClamping_Func");
    TriggerEnable(libHMDV_gt_HeroMedivhPortalPortalMasterySelectionClamping, false);
    TriggerAddEventPlayerEffectUsed(libHMDV_gt_HeroMedivhPortalPortalMasterySelectionClamping, c_playerAny, "MedivhPortalMarkerSpawnPersistent");
}

//--------------------------------------------------------------------------------------------------
// Trigger: Hero - Medivh - Portal Portal Mastery Morph Back To Medivh
//--------------------------------------------------------------------------------------------------
bool libHMDV_gt_HeroMedivhPortalPortalMasteryMorphBackToMedivh_Func (bool testConds, bool runActions) {
    // Variable Declarations
    int lv_portal2Owner;
    unit lv_portal2Caster;
    unit lv_medivh;

    // Variable Initialization

    // Actions
    if (!runActions) {
        return true;
    }

    lv_portal2Caster = EventUnit();
    lv_portal2Owner = UnitGetOwner(lv_portal2Caster);
    lv_medivh = libGame_gv_players[lv_portal2Owner].lv_heroUnit;
    UnitCreateEffectUnit(lv_medivh, "MedivhAbilityPrepareSet", lv_medivh);
    UnitCreateEffectUnit(lv_medivh, "MedivhPortalCooldown", lv_medivh);
    UnitBehaviorAdd(lv_medivh, "MedivhPortalPortalMasteryCastStun", lv_medivh, 1);
    libNtve_gf_MakeUnitFacePoint(lv_medivh, EventUnitTargetPoint(), 0.0625);
    if ((UnitOrderCount(lv_medivh) <= 1)) {
        UnitIssueOrder(lv_medivh, Order(AbilityCommand("stop", 0)), c_orderQueueReplace);
    }

    return true;
}

//--------------------------------------------------------------------------------------------------
void libHMDV_gt_HeroMedivhPortalPortalMasteryMorphBackToMedivh_Init () {
    libHMDV_gt_HeroMedivhPortalPortalMasteryMorphBackToMedivh = TriggerCreate("libHMDV_gt_HeroMedivhPortalPortalMasteryMorphBackToMedivh_Func");
    TriggerEnable(libHMDV_gt_HeroMedivhPortalPortalMasteryMorphBackToMedivh, false);
    TriggerAddEventUnitAbility(libHMDV_gt_HeroMedivhPortalPortalMasteryMorphBackToMedivh, null, AbilityCommand("MedivhPortal2", 0), c_abilEffectStageCast, false);
}

//--------------------------------------------------------------------------------------------------
// Trigger: Hero - Medivh - Force of Will Behavior Responses
//--------------------------------------------------------------------------------------------------
bool libHMDV_gt_HeroMedivhForceofWillBehaviorResponses_Func (bool testConds, bool runActions) {
    // Variable Declarations
    fixed lv_damageTaken;
    unit lv_unit;
    fixed lv_verticalOffset;
    fixed lv_horizOffset;
    unit lv_caster;
    unit lv_shieldedUnit;
    int lv_ownerofShieldedUnit;

    // Variable Initialization
    lv_damageTaken = EventUnitBehaviorCumulativeDamageModification();
    lv_unit = EventUnit();
    lv_verticalOffset = 2.0;
    lv_horizOffset = RandomFixed(-0.4, -0.6);

    // Conditions
    if (testConds) {
        if (!((UnitGetOwner(lv_unit) <= libCore_gv_bALMaxPlayers))) {
            return false;
        }

        if (!((UnitFilterMatch(lv_unit, UnitGetOwner(lv_unit), libCore_gv_filtersHeroic) == true))) {
            return false;
        }
    }

    // Actions
    if (!runActions) {
        return true;
    }

    if ((EventUnitBehaviorChange() == c_unitBehaviorChangeIncrease)) {
        lv_shieldedUnit = lv_unit;
        lv_ownerofShieldedUnit = UnitGetOwner(lv_shieldedUnit);
        lv_caster = UnitBehaviorEffectUnit(lv_shieldedUnit, EventUnitBehavior(), c_effectUnitCaster, 0);
        libHMDV_gv_medivhForceofWillCaster[UnitGetOwner(lv_shieldedUnit)] = lv_caster;
        libHMDV_gv_medivhForceofWillCasterOwner[UnitGetOwner(lv_shieldedUnit)] = UnitGetOwner(lv_caster);
        PlayerGroupAdd(libHMDV_gv_medivhForceofWillPlayerGroup[lv_ownerofShieldedUnit], lv_ownerofShieldedUnit);
        PlayerGroupAdd(libHMDV_gv_medivhForceofWillPlayerGroup[lv_ownerofShieldedUnit], UnitGetOwner(lv_caster));
    }
    else if ((EventUnitBehaviorChange() == c_unitBehaviorChangeDecrease)) {
        lv_shieldedUnit = lv_unit;
        lv_ownerofShieldedUnit = UnitGetOwner(lv_shieldedUnit);
        if ((lv_damageTaken > 0.0) && (PlayerHasTalent(libHMDV_gv_medivhForceofWillCasterOwner[lv_ownerofShieldedUnit], "MedivhForceOfWillReabsorption") == true)) {
            lv_verticalOffset = 1.0;
            FloatingCombatElementCreateNumberTextAtUnit(libHMDV_gv_medivhForceofWillPlayerGroup[lv_ownerofShieldedUnit], "FloatingCombatElements/FloatingCombatAmountReadable", "", lv_shieldedUnit, FixedToInt(lv_damageTaken), StringExternal("Param/Value/lib_HMDV_C69061B6"), libNtve_gv_FloatingCombatTextAutoRandomSeed);
            CatalogFieldValueSet(c_gameCatalogEffect, "MedivhForceOfWillReabsorptionHeal", "RechargeVitalRate", libHMDV_gv_medivhForceofWillCasterOwner[lv_ownerofShieldedUnit], FixedToString((lv_damageTaken * 0.5), c_fixedPrecisionAny));
            UnitCreateEffectUnitWithSource(libHMDV_gv_medivhForceofWillCaster[lv_ownerofShieldedUnit], "MedivhForceOfWillReabsorptionHeal", lv_shieldedUnit, c_gameCatalogAbil, "MedivhForceOfWill");
        }
        else if ((lv_damageTaken > 0.0) && (PlayerHasTalent(libHMDV_gv_medivhForceofWillCasterOwner[lv_ownerofShieldedUnit], "MedivhForceOfWillReabsorption") == false)) {
            FloatingCombatElementCreateNumberTextAtUnit(libHMDV_gv_medivhForceofWillPlayerGroup[lv_ownerofShieldedUnit], "FloatingCombatElements/FloatingCombatAmountReadable", "", lv_shieldedUnit, FixedToInt(lv_damageTaken), StringExternal("Param/Value/lib_HMDV_EB9E6C70"), libNtve_gv_FloatingCombatTextAutoRandomSeed);
        }
        PlayerGroupClear(libHMDV_gv_medivhForceofWillPlayerGroup[lv_ownerofShieldedUnit]);
    }
    return true;
}

//--------------------------------------------------------------------------------------------------
void libHMDV_gt_HeroMedivhForceofWillBehaviorResponses_Init () {
    libHMDV_gt_HeroMedivhForceofWillBehaviorResponses = TriggerCreate("libHMDV_gt_HeroMedivhForceofWillBehaviorResponses_Func");
    TriggerEnable(libHMDV_gt_HeroMedivhForceofWillBehaviorResponses, false);
    TriggerAddEventUnitBehaviorChange(libHMDV_gt_HeroMedivhForceofWillBehaviorResponses, null, "MedivhForceOfWill", c_unitBehaviorChangeIncrease);
    TriggerAddEventUnitBehaviorChange(libHMDV_gt_HeroMedivhForceofWillBehaviorResponses, null, "MedivhForceOfWill", c_unitBehaviorChangeDecrease);
}

//--------------------------------------------------------------------------------------------------
// Trigger: Hero - Medivh - Transform: Raven After Port To Town
//--------------------------------------------------------------------------------------------------
bool libHMDV_gt_HeroMedivhTransformRavenAfterPortToTown_Func (bool testConds, bool runActions) {
    // Variable Declarations
    int lv_player;

    // Variable Initialization
    lv_player = libGame_gf_HeroPortedBackToTownPlayer();

    // Conditions
    if (testConds) {
        if (!((UnitGetType(libGame_gv_players[lv_player].lv_heroUnit) == "HeroMedivh"))) {
            return false;
        }
    }

    // Actions
    if (!runActions) {
        return true;
    }

    UnitCreateEffectUnit(libGame_gv_players[lv_player].lv_heroUnit, "MedivhTransformRavenFountainSet", libGame_gv_players[lv_player].lv_heroUnit);
    return true;
}

//--------------------------------------------------------------------------------------------------
void libHMDV_gt_HeroMedivhTransformRavenAfterPortToTown_Init () {
    libHMDV_gt_HeroMedivhTransformRavenAfterPortToTown = TriggerCreate("libHMDV_gt_HeroMedivhTransformRavenAfterPortToTown_Func");
    TriggerEnable(libHMDV_gt_HeroMedivhTransformRavenAfterPortToTown, false);
    libGame_gf_HeroPortedBackToTown(libHMDV_gt_HeroMedivhTransformRavenAfterPortToTown);
}

//--------------------------------------------------------------------------------------------------
// Trigger: Hero - Medivh - Transform: Raven Mounting Special Case
//--------------------------------------------------------------------------------------------------
bool libHMDV_gt_HeroMedivhTransformRavenMountingSpecialCase_Func (bool testConds, bool runActions) {
    // Variable Declarations
    int lv_player;

    // Variable Initialization
    lv_player = libGame_gf_HeroSpecialCaseMountingPlayer();

    // Conditions
    if (testConds) {
        if (!((UnitGetType(libGame_gv_players[lv_player].lv_heroUnit) == "HeroMedivh"))) {
            return false;
        }
    }

    // Actions
    if (!runActions) {
        return true;
    }

    UnitCreateEffectUnit(libGame_gv_players[lv_player].lv_heroUnit, "MedivhTransformRavenFountainSet", libGame_gv_players[lv_player].lv_heroUnit);
    return true;
}

//--------------------------------------------------------------------------------------------------
void libHMDV_gt_HeroMedivhTransformRavenMountingSpecialCase_Init () {
    libHMDV_gt_HeroMedivhTransformRavenMountingSpecialCase = TriggerCreate("libHMDV_gt_HeroMedivhTransformRavenMountingSpecialCase_Func");
    TriggerEnable(libHMDV_gt_HeroMedivhTransformRavenMountingSpecialCase, false);
    libGame_gf_HeroSpecialCaseMounting(libHMDV_gt_HeroMedivhTransformRavenMountingSpecialCase);
}

//--------------------------------------------------------------------------------------------------
// Trigger: Hero - Medivh - Transform: Swap To Medivh
//--------------------------------------------------------------------------------------------------
bool libHMDV_gt_HeroMedivhTransformSwapToMedivh_Func (bool testConds, bool runActions) {
    // Variable Declarations
    int lv_player;
    int lv_index;

    // Variable Initialization

    // Conditions
    if (testConds) {
        if (!((UnitGetOwner(EventUnit()) >= 1))) {
            return false;
        }

        if (!((UnitGetOwner(EventUnit()) <= 10))) {
            return false;
        }

        if (!((UnitTestState(EventUnit(), c_unitStateHallucination) == false))) {
            return false;
        }

        if (!((UnitIsAlive(EventUnit()) == true))) {
            return false;
        }

        if (!((UnitBehaviorCount(EventUnit(), "MedivhForceOfWill") > 0))) {
            return false;
        }
    }

    // Actions
    if (!runActions) {
        return true;
    }

    lv_player = UnitGetOwner(EventUnit());
    lv_index = libUIUI_gf_UIUnitStatusFramesGetUnitIndex(lv_player, EventUnit());
    Wait(0.0625, c_timeGame);
    DialogControlSendAnimationEvent(libUIUI_gv_uIHeroStatusFrames[lv_player].lv_unitHealthBarInvincible[lv_index], PlayerGroupAll(), "InvincibleOn");
    return true;
}

//--------------------------------------------------------------------------------------------------
void libHMDV_gt_HeroMedivhTransformSwapToMedivh_Init () {
    libHMDV_gt_HeroMedivhTransformSwapToMedivh = TriggerCreate("libHMDV_gt_HeroMedivhTransformSwapToMedivh_Func");
    TriggerEnable(libHMDV_gt_HeroMedivhTransformSwapToMedivh, false);
    TriggerAddEventUnitBehaviorChange(libHMDV_gt_HeroMedivhTransformSwapToMedivh, null, "MedivhTransformRaven", c_unitBehaviorChangeDestroy);
}

void libHMDV_InitTriggers () {
    libHMDV_gt_HeroAIMedivhHasLanded_Init();
    libHMDV_gt_HeroAIMedivhHasCastRavenForm_Init();
    libHMDV_gt_HeroAIAIMedivhHasCastPortalOne_Init();
    libHMDV_gt_HeroAIAIMedivhRegisterPortalCast_Init();
    libHMDV_gt_HeroAIAIMedivhUnregisterPortal_Init();
    libHMDV_gt_HeroAIMiscModInitialization_Init();
    libHMDV_gt_HeroAIAddToTierDataMedivh_Init();
    libHMDV_gt_HeroAIInitAbilitiesMedivh_Init();
    libHMDV_gt_HeroMedivhLeyLineSealOverlayOn_Init();
    libHMDV_gt_HeroMedivhLeyLineSealOverlayOff_Init();
    libHMDV_gt_HeroMedivhPortalTeleport_Init();
    libHMDV_gt_HeroMedivhPortalCameraPan_Init();
    libHMDV_gt_HeroMedivhPortalPortalMasterySelectionClamping_Init();
    libHMDV_gt_HeroMedivhPortalPortalMasteryMorphBackToMedivh_Init();
    libHMDV_gt_HeroMedivhForceofWillBehaviorResponses_Init();
    libHMDV_gt_HeroMedivhTransformRavenAfterPortToTown_Init();
    libHMDV_gt_HeroMedivhTransformRavenMountingSpecialCase_Init();
    libHMDV_gt_HeroMedivhTransformSwapToMedivh_Init();
}

//--------------------------------------------------------------------------------------------------
// Library Initialization
//--------------------------------------------------------------------------------------------------
bool libHMDV_InitLib_completed = false;

void libHMDV_InitLib () {
    if (libHMDV_InitLib_completed) {
        return;
    }

    libHMDV_InitLib_completed = true;

    libHMDV_InitLibraries();
    libHMDV_InitVariables();
    libHMDV_InitCustomScript();
    libHMDV_InitTriggers();
}

