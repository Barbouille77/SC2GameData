include "TriggerLibs/NativeLib"
include "TriggerLibs/HeroesLib"
include "TriggerLibs/AILib"

include "LibHVAL_h"

//--------------------------------------------------------------------------------------------------
// Library: Valeera
//--------------------------------------------------------------------------------------------------
// External Library Initialization
void libHVAL_InitLibraries () {
    libNtve_InitVariables();
    libCore_InitVariables();
    libAIAI_InitVariables();
}

// Variable Initialization
bool libHVAL_InitVariables_completed = false;

void libHVAL_InitVariables () {
    if (libHVAL_InitVariables_completed) {
        return;
    }

    libHVAL_InitVariables_completed = true;

}

// Custom Script
//--------------------------------------------------------------------------------------------------
// Custom Script: #Include Valeera Tactical AI
//--------------------------------------------------------------------------------------------------
include "StormTactical.galaxy"  
include "ValeeraTactical.galaxy" 

void libHVAL_InitCustomScript () {
}

// Functions
void libHVAL_gf_HeroValeeraIncrementHeroCountFunction () {
    // Automatic Variable Declarations
    // Implementation
    libHVAL_gv_heroValeeraTriggerRegistrationVariable += 1;
    if ((libHVAL_gv_heroValeeraTriggerRegistrationVariable == 1)) {
        TriggerEnable(libHVAL_gt_HeroValeeraGainAComboPoint, true);
        TriggerEnable(libHVAL_gt_HeroValeeraVigorGlobeCollection, true);
    }

}

void libHVAL_gf_HeroValeeraDecrementHeroCountFunction () {
    // Automatic Variable Declarations
    // Implementation
    libHVAL_gv_heroValeeraTriggerRegistrationVariable -= 1;
    if ((libHVAL_gv_heroValeeraTriggerRegistrationVariable < 0)) {
        libHVAL_gv_heroValeeraTriggerRegistrationVariable = 0;
    }

    if ((libHVAL_gv_heroValeeraTriggerRegistrationVariable == 0)) {
        TriggerEnable(libHVAL_gt_HeroValeeraGainAComboPoint, false);
        TriggerEnable(libHVAL_gt_HeroValeeraVigorGlobeCollection, false);
    }

}

// Triggers
//--------------------------------------------------------------------------------------------------
// Trigger: HeroAI - Misc Mod Initialization
//--------------------------------------------------------------------------------------------------
bool libHVAL_gt_HeroAIMiscModInitialization_Func (bool testConds, bool runActions) {
    // Automatic Variable Declarations
    // Actions
    if (!runActions) {
        return true;
    }

    libCore_gf_RegisterSegregationTrigger(libCore_ge_SegregationTriggerTypes_HeroAIInitializeHeroTierData, libHVAL_gt_HeroAIAddToTierDataValeera);
    libCore_gf_RegisterSegregationTrigger(libCore_ge_SegregationTriggerTypes_HeroAIInitAbilities, libHVAL_gt_HeroAIInitAbilitiesValeera);
    return true;
}

//--------------------------------------------------------------------------------------------------
void libHVAL_gt_HeroAIMiscModInitialization_Init () {
    libHVAL_gt_HeroAIMiscModInitialization = TriggerCreate("libHVAL_gt_HeroAIMiscModInitialization_Func");
    TriggerAddEventMapInit(libHVAL_gt_HeroAIMiscModInitialization);
}

//--------------------------------------------------------------------------------------------------
// Trigger: HeroAI - Add To Tier Data - Valeera
//--------------------------------------------------------------------------------------------------
bool libHVAL_gt_HeroAIAddToTierDataValeera_Func (bool testConds, bool runActions) {
    // Automatic Variable Declarations
    // Actions
    if (!runActions) {
        return true;
    }

    libAIAI_gf_HeroAIAddHeroToTierData(libAIAI_ge_HeroAIHeroTiers_TierMid, "Valeera");
    return true;
}

//--------------------------------------------------------------------------------------------------
void libHVAL_gt_HeroAIAddToTierDataValeera_Init () {
    libHVAL_gt_HeroAIAddToTierDataValeera = TriggerCreate("libHVAL_gt_HeroAIAddToTierDataValeera_Func");
}

//--------------------------------------------------------------------------------------------------
// Trigger: HeroAI - Init Abilities - Valeera
//--------------------------------------------------------------------------------------------------
bool libHVAL_gt_HeroAIInitAbilitiesValeera_Func (bool testConds, bool runActions) {
    // Automatic Variable Declarations
    // Actions
    if (!runActions) {
        return true;
    }

    if ((UnitGetType(libCore_gv_segTriggerUnit) == "HeroValeera")) {
        libAIAI_gv_heroAIInitAbilitesHeroFound = true;
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_hasTactical = true;
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_hasMount = true;
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_castAbility[0] = AbilityCommand("ValeeraSinisterStrike", 0);
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_abilityType[0] = libAIAI_ge_HeroAISpellType_TargetEnemy;
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_abilityRange[0] = 2.0;
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_castAbility[1] = AbilityCommand("ValeeraBladeFlurry", 0);
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_abilityType[1] = libAIAI_ge_HeroAISpellType_PointEnemy;
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_abilityRange[1] = 4.0;
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_castAbility[2] = AbilityCommand("ValeeraEviscerate", 0);
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_abilityType[2] = libAIAI_ge_HeroAISpellType_TargetEnemy;
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_abilityRange[2] = 2.0;
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_castAbility[3] = null;
        libAIAI_gv_aIHeroes[libCore_gv_segTriggerPlayer].lv_castAbility[4] = null;
    }

    return true;
}

//--------------------------------------------------------------------------------------------------
void libHVAL_gt_HeroAIInitAbilitiesValeera_Init () {
    libHVAL_gt_HeroAIInitAbilitiesValeera = TriggerCreate("libHVAL_gt_HeroAIInitAbilitiesValeera_Func");
}

//--------------------------------------------------------------------------------------------------
// Trigger: Hero - Valeera - Gain A Combo Point
//--------------------------------------------------------------------------------------------------
bool libHVAL_gt_HeroValeeraGainAComboPoint_Func (bool testConds, bool runActions) {
    // Variable Declarations
    unit lv_valeera;
    int lv_totalCP;
    int lv_player;
    unit lv_target;

    // Automatic Variable Declarations
    // Variable Initialization

    // Actions
    if (!runActions) {
        return true;
    }

    lv_valeera = EventPlayerEffectUsedUnit(c_effectUnitCaster);
    lv_player = UnitGetOwner(lv_valeera);
    lv_target = EventPlayerEffectUsedUnit(c_effectUnitTarget);
    lv_totalCP = FixedToInt(UnitGetTokenCount(lv_valeera, "ValeeraComboPointsToken"));
    if ((lv_totalCP <= 2)) {
        TextExpressionSetToken("Param/Expression/lib_HVAL_F0820B46", "A", IntToText(lv_totalCP));
        FloatingCombatElementCreateTextAtPoint(PlayerGroupSingle(lv_player), "FloatingCombatElements/FloatingCombatNormalAmountReceived", "ShieldState", PointWithOffset(UnitGetPosition(lv_target), -0.75, 0.75), TextExpressionAssemble("Param/Expression/lib_HVAL_F0820B46"), libNtve_gv_FloatingCombatTextAutoRandomSeed);
    }
    else {
        TextExpressionSetToken("Param/Expression/lib_HVAL_9E361351", "A", IntToText(lv_totalCP));
        FloatingCombatElementCreateTextAtPoint(PlayerGroupSingle(lv_player), "FloatingCombatElements/FloatingCombatNormalAmountReceived", "ShieldState", PointWithOffset(UnitGetPosition(lv_target), -0.75, 0.75), TextExpressionAssemble("Param/Expression/lib_HVAL_9E361351"), libNtve_gv_FloatingCombatTextAutoRandomSeed);
    }
    return true;
}

//--------------------------------------------------------------------------------------------------
void libHVAL_gt_HeroValeeraGainAComboPoint_Init () {
    libHVAL_gt_HeroValeeraGainAComboPoint = TriggerCreate("libHVAL_gt_HeroValeeraGainAComboPoint_Func");
    TriggerEnable(libHVAL_gt_HeroValeeraGainAComboPoint, false);
    TriggerAddEventPlayerEffectUsed(libHVAL_gt_HeroValeeraGainAComboPoint, c_playerAny, "ValeeraComboPointsModifyToken");
}

//--------------------------------------------------------------------------------------------------
// Trigger: Hero - Valeera - Vigor - Globe Collection
//--------------------------------------------------------------------------------------------------
bool libHVAL_gt_HeroValeeraVigorGlobeCollection_Func (bool testConds, bool runActions) {
    // Variable Declarations
    int lv_player;
    int lv_textTag;
    unit lv_valeera;

    // Automatic Variable Declarations
    // Variable Initialization
    lv_player = EventPlayerEffectUsedUnitOwner(c_effectPlayerTarget);
    lv_textTag = c_textTagNone;
    lv_valeera = EventPlayerEffectUsedUnit(c_effectUnitTarget);

    // Conditions
    if (testConds) {
        if (!((PlayerHasTalent(EventPlayer(), "ValeeraVigor") == true))) {
            return false;
        }
    }

    // Actions
    if (!runActions) {
        return true;
    }

    UnitCreateEffectUnit(lv_valeera, "ValeeraVigorQuestModifyToken", lv_valeera);
    return true;
}

//--------------------------------------------------------------------------------------------------
void libHVAL_gt_HeroValeeraVigorGlobeCollection_Init () {
    libHVAL_gt_HeroValeeraVigorGlobeCollection = TriggerCreate("libHVAL_gt_HeroValeeraVigorGlobeCollection_Func");
    TriggerEnable(libHVAL_gt_HeroValeeraVigorGlobeCollection, false);
    TriggerAddEventPlayerEffectUsed(libHVAL_gt_HeroValeeraVigorGlobeCollection, c_playerAny, "RegenGlobeImpactSet");
}

void libHVAL_InitTriggers () {
    libHVAL_gt_HeroAIMiscModInitialization_Init();
    libHVAL_gt_HeroAIAddToTierDataValeera_Init();
    libHVAL_gt_HeroAIInitAbilitiesValeera_Init();
    libHVAL_gt_HeroValeeraGainAComboPoint_Init();
    libHVAL_gt_HeroValeeraVigorGlobeCollection_Init();
}

//--------------------------------------------------------------------------------------------------
// Library Initialization
//--------------------------------------------------------------------------------------------------
bool libHVAL_InitLib_completed = false;

void libHVAL_InitLib () {
    if (libHVAL_InitLib_completed) {
        return;
    }

    libHVAL_InitLib_completed = true;

    libHVAL_InitLibraries();
    libHVAL_InitVariables();
    libHVAL_InitCustomScript();
    libHVAL_InitTriggers();
}

